// Telegraph Sockets
// Sets up websockets (currently through socket.io)
// -------------------------------------------------- //

module.exports.setup = function(server) {

    server.io = require('socket.io').listen(server.express);
    
    server.io.configure(function() {
        server.io.set("log level", (server.silent_mode) ? 0 : 2);
    });

    server.websocket_events = [];

    server.register = server.on;

    server.on = function(name, action) {

        switch(name.split(":")[0]) {
            
        case "websocket":

            server.register(name, action);
            
            server.websocket_events.push({
                name   : name.split(":")[1], 
                action : function(data) {
                    server.info("emitting " + name);
                    server.emit(name, data);
                }
            });

            break;

        default:
            server.register(name, action);
        }
        

        return server;
    };

    server.send = function(name, values) {
        server.io.sockets.emit(name, values);
    };

    server.volley = function(name, values) {
        server.io.sockets.volatile.emit(name, values);
    };

    server.broadcast = function(name, values) {
        server.io.sockets.broadcast(name, values);
    };
    
};


module.exports.install = function(server) {

    var events = server.websocket_events;
    
    server.io.sockets.on("connection", function(socket) {

        server.emit("websocket:connection", socket);

        socket.on("message", function(socket) {
            console.log("message");
        });

        // Add websocket events
        events.forEach(function(e) {

            // Is it the connection event?
            if (e.name === "connection") {
                // yes : fire the event
                e.action(socket);
            } else { 
                // no : register the event
                socket.on(e.name, e.action);
            }
            
        });

    });

    server.io.sockets.on("disconnect", function(socket) {
        server.emit("websocket:disconnect", socket);
    });
    
};
