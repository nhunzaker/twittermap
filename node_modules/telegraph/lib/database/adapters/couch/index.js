
// -------------------------------------------------- //

module.exports.install = function(server) {

    var info   = server.database
    ,   cradle = require('./neo-cradle/lib/cradle')
    ,   dir    = process.cwd() + "/db/";

    var db = server.db = new(cradle.Connection)(info.host, info.port || 5984, {
        auth: info.auth
    }).database(info.dbname);

    console.log(db.info());


    // Check connection
    // -------------------------------------------------- //

    db.exists(function (err, exists) {
        
        if (err) { server.error("CouchDB " + err); } 
        
        else if (exists) {
            info.connected = true;
            server.info("CouchDB is connected at %s", info.host);
        } else {
            server.warn('CouchDB database does not exist. Now creating...');

            db.create(function(err) {
                if (err) return server.error(err);
                server.info("Database %s  was created.", info.dbname);
            });
        }
    });


    // Setup Model
    // -------------------------------------------------- //
    
    require("./model")(server);

    
    // Database Events
    // -------------------------------------------------- //
    
    if (server.database.changes === "true") {
        server.db.changes({ include_doc: true }).on('response', function (res) {

            res.on('data', function (change) {
                change.id && db.get(change.id, function(err, doc) {
                    var event = "db:change-" + doc.type;
                    server.emit(event, change, doc);
                    server.info("emitting " + event);
                });
            });
            
            res.on('end', function () {
                server.emit("db:end");
                server.info("emitting db:end");
            });

        });
    }
    
};
