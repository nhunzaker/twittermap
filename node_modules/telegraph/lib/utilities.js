// Utilities
// -------------------------------------------------- //

var fs     = require('fs'),   
    config = require("konphyg")(process.cwd() + "/config")

// A nifty helper to load all files within a directory
// 
// Note : This is basically a glorified "require all in directory" function.
//        Should further releases of node include such functionality, it will
//        be deprecated.

module.exports.load = function(module) {
    
    // Validates if a file is not hidden and ends in .js or .coffee
    var fileEX = /^[^.].+\.(js|coffee)/
        ,   d      = process.cwd() + "/" + module;

    // Try to read the directory
    try { fs.statSync(d); }
    // No? Return an error;
    catch (e) { return this; }

    (function traverse(dir, stack) {

        stack.push(dir);
        
        fs.readdirSync(stack.join('/')).forEach(function (file) {
            
            if (file[0] == '.' || file === 'vendor') return;
            
            var path = stack.concat([file]).join('/'),
                stat = fs.statSync(path);
            
            if ( stat.isFile() && fileEX.test(path)) {
                require(path);
            } else if (stat.isDirectory()) {
                traverse(file, stack);
            }

        });
        
        stack.pop();
        
    })(d, []);
    
    return this;
};


module.exports.configure = function(server) {
    
    // Get all configuration files and filter by json
    // -------------------------------------------------- //

    var configs = fs.readdirSync(process.cwd() + "/config").filter(function(file) {
        return file.split(".").slice(-1).join("") === "json";
    }).forEach(function(file) {

        file = file.split(".json")[0];

        server[file] = config(file);
    });

}
