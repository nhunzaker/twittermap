#!/usr/bin/env node

require("colors");

var repl    = require("repl")
,   local   = process.cwd()
,   fs      = require('fs')
,   _       = require("underscore") 
;

global.args = process.argv.slice(2);

var command = args.shift();

switch (command) {

default: case "h": case "help":

  var messages = ['\nTelegraph Commands:'.cyan];
  
  var commands = [
    '----------------------------------------------------------',
    '  h  help                      Display usage information  ',
    '  s  start [port]              Start a telegraph server   ',
    '  c  console                   Start a telegraph REPL     ',
    '  i  init                      Initialize telegraph app   ',
    '----------------------------------------------------------'
  ];

  commands.forEach(function (cmd) {
    messages.push(cmd);
  });
  
  console.log(messages.join('\n') + "\n");

  break;

case "c": case "console":

  app = require(local + "/server");        
  app.silent_mode = true;
  
  console.log("\nStarting console mode, logs will be silenced...\n");
  
  repl.start("> ");
  break;


case "s": case "start":
  require(process.cwd() + "/server.js");
  break;


case "init":

  var fs        = require("fs")
  ,   fileEX    = /^[^.].+/
  ,   templates = __dirname + "/templates";

  (function traverse(dir, stack) {

    stack.push(dir);
    
    fs.readdirSync(stack.join('/')).forEach(function (file) {
      
      if (file[0] == '.' || file === 'vendor') return;
      
      var path    = stack.concat([file]).join('/')
      ,   current = process.cwd() + "/" + stack.slice(1).join("/")
      ,   stat    = fs.statSync(path)
      ;
      
      if ( stat.isFile() && fileEX.test(path)) {
        var content = fs.readFileSync(path);
        fs.writeFileSync(current + "/" + file, content);
      } else if (stat.isDirectory()) {
        fs.mkdirSync(current + "/" + file);
        traverse(file, stack);
      }

    });
    
    stack.pop();
    
  })(templates, []);
  
  // Cover other directories
  fs.mkdirSync(process.cwd() + "/app/models");
  
  console.log("Success".green.bold + "! Check out your new Telegraph app at " + process.cwd().green.bold);

  break;
};
